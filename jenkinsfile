pipeline {
    agent { label 'built-in' }   // ‚úÖ Jenkins Controller (Build + Push)

    environment {
        IMAGE_NAME        = "tapashranjannandi/simple-django-app-1"
        DOCKERHUB_CREDS   = 'dockerhub-creds'

        BLUE_DEPLOYMENT_FILE  = "deployment_blue.yaml"
        BLUE_SERVICE_FILE     = "service-blue.yaml"

        GREEN_DEPLOYMENT_FILE = "deployment-green.yaml"
        GREEN_SERVICE_FILE    = "service-green.yaml"
    }

    options {
        timestamps()
        timeout(time: 40, unit: 'MINUTES')
    }

    // ‚úÖ GITHUB WEBHOOK TRIGGER
    triggers {
        githubPush()
    }

    stages {

        // ‚úÖ 1. CHECKOUT
        stage('Checkout') {
            steps {
                git branch: 'master',
                    url: 'https://github.com/TAPASHRANJANNANDI/simple-django-app.git'
            }
        }

        // ‚úÖ 2. AUTO-DETECT NON-LIVE ENV
        stage('Select Non-Live Environment Automatically') {
              agent { label 'server' }
            steps {
                script {
                    // ‚úÖ Check which service is live
                    def liveColor = sh(
    script: "kubectl get svc simple-django-app-service -o jsonpath=\"{.spec.selector['color']}\" 2>/dev/null || echo none",
    returnStdout: true
).trim()


                    if (liveColor == "blue") {
                        env.DEPLOY_ENV = "green"
                        env.DEPLOY_FILE = env.GREEN_DEPLOYMENT_FILE
                        env.SERVICE_FILE = env.GREEN_SERVICE_FILE
                    } else {
                        env.DEPLOY_ENV = "blue"
                        env.DEPLOY_FILE = env.BLUE_DEPLOYMENT_FILE
                        env.SERVICE_FILE = env.BLUE_SERVICE_FILE
                    }

                    env.IMAGE_TAG = env.DEPLOY_ENV

                    echo "‚úÖ LIVE ENV    : ${liveColor}"
                    echo "‚úÖ NON-LIVE ENV: ${env.DEPLOY_ENV}"
                }
            }
        }

        // ‚úÖ 3. BUILD IMAGE
        stage('Build Docker Image') {
            steps {
                sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
            }
        }

        // ‚úÖ 4. PUSH IMAGE
        stage('Push Docker Image') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: env.DOCKERHUB_CREDS,
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )
                ]) {
                    sh """
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                        docker push ${IMAGE_NAME}:${IMAGE_TAG}
                    """
                }
            }
        }

        // ‚úÖ 5. AUTO DEPLOY TO NON-LIVE (K8s AGENT)
        stage('Deploy to Kubernetes (Non-Live)') {
            agent { label 'server' }
            steps {
                sh """
                    echo "üöÄ Auto deploying to NON-LIVE: ${DEPLOY_ENV}"

                    kubectl apply -f kubernetes/${DEPLOY_FILE}
                    kubectl apply -f kubernetes/${SERVICE_FILE}

                    kubectl get pods
                    kubectl get svc
                """
            }
        }

        // ‚úÖ 6. MANUAL QA APPROVAL FOR PROD
        stage('Manual Approval for Traffic Switch') {
            steps {
                input message: "‚úÖ Testing Completed on ${DEPLOY_ENV}. Switch LIVE traffic?"
            }
        }

        // ‚úÖ 7. SWITCH LIVE TRAFFIC
        stage('Switch Production Traffic') {
            agent { label 'server' }
            steps {
                sh """
                    echo "üîÅ Switching production traffic to ${DEPLOY_ENV}"
                    kubectl apply -f kubernetes/${SERVICE_FILE}
                    kubectl get svc
                """
            }
        }
    }

    post {
        success {
            echo "‚úÖ Webhook Triggered Blue-Green Deployment Completed!"
        }
        failure {
            echo "‚ùå Webhook Deployment Failed!"
        }
    }
}
