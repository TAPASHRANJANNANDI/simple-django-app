pipeline {
   agent { label 'built-in' } // ‚úÖ Default runs on Jenkins master (build + push)

    environment {
        IMAGE_NAME        = "tapashranjannandi/simple-django-app-1"
        DOCKERHUB_CREDS   = 'dockerhub-creds'

        BLUE_DEPLOYMENT_FILE  = "deployment_blue.yaml"
        BLUE_SERVICE_FILE     = "service-blue.yaml"

        GREEN_DEPLOYMENT_FILE = "deployment-green.yaml"
        GREEN_SERVICE_FILE    = "service-green.yaml"
    }

    options {
        timestamps()
        timeout(time: 40, unit: 'MINUTES')
    }

    parameters {
        choice(
            name: 'TARGET_ENV',
            choices: ['blue', 'green'],
            description: 'Deploy to NON-LIVE environment only'
        )
    }

    stages {

        // ‚úÖ 1. CHECKOUT ON MASTER
        stage('Checkout') {
            steps {
                git branch: 'master',
                    url: 'https://github.com/TAPASHRANJANNANDI/simple-django-app.git'
            }
        }

        // ‚úÖ 2. SET TARGET ENV ON MASTER
        stage('Set Target Environment') {
            steps {
                script {
                    env.DEPLOY_ENV = params.TARGET_ENV
                    env.IMAGE_TAG = params.TARGET_ENV

                    if (params.TARGET_ENV == 'blue') {
                        env.DEPLOY_FILE  = env.BLUE_DEPLOYMENT_FILE
                        env.SERVICE_FILE = env.BLUE_SERVICE_FILE
                    } else {
                        env.DEPLOY_FILE  = env.GREEN_DEPLOYMENT_FILE
                        env.SERVICE_FILE = env.GREEN_SERVICE_FILE
                    }

                    echo "‚úÖ Target Env       : ${env.DEPLOY_ENV}"
                    echo "‚úÖ Deployment YAML : ${env.DEPLOY_FILE}"
                    echo "‚úÖ Service YAML    : ${env.SERVICE_FILE}"
                }
            }
        }

        // ‚úÖ 3. BUILD ON MASTER
        stage('Build Docker Image') {
            steps {
                sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
            }
        }

        // ‚úÖ 4. PUSH ON MASTER
        stage('Push Docker Image') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: env.DOCKERHUB_CREDS,
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )
                ]) {
                    sh """
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                        docker push ${IMAGE_NAME}:${IMAGE_TAG}
                    """
                }
            }
        }

        // ‚úÖ 5. DEPLOY ONLY ON KUBERNETES AGENT (`server`)
        stage('Deploy to Kubernetes (Non-Live)') {
            agent { label 'server' }   // üëà executes ONLY here
            steps {
                sh """
                    echo "üöÄ Deploying to ${DEPLOY_ENV} environment..."

                    kubectl apply -f kubernetes/${DEPLOY_FILE}
                    kubectl apply -f kubernetes/${SERVICE_FILE}

                    kubectl get pods
                    kubectl get svc
                """
            }
        }

        // ‚úÖ 6. MANUAL APPROVAL (RUNS ON MASTER)
        stage('Manual Approval for Traffic Switch') {
            steps {
                input message: "‚úÖ Verify ${env.DEPLOY_ENV} environment. Switch production traffic?"
            }
        }

        // ‚úÖ 7. LIVE SWITCH ONLY ON KUBERNETES AGENT (`server`)
        stage('Switch Production Traffic') {
            agent { label 'server' }   // üëà executes ONLY here
            steps {
                sh """
                    echo "üîÅ Switching LIVE traffic..."
                    kubectl apply -f kubernetes/${SERVICE_FILE}
                    kubectl get svc
                """
            }
        }
    }

    post {
        success {
            echo "‚úÖ Blue-Green Deployment Completed Successfully!"
        }
        failure {
            echo "‚ùå Deployment Failed!"
        }
    }
}
